{% extends 'core/base.html' %} {% load static %} {% block title %} 
{{room.name}} | {% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/chat.css' %}" />
{% endblock %} {% block content %}
<div class="header">
  <h1>{{ room.name }}</h1>
</div>

<div class="chat-layout">
  <!-- –ë–ª–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω -->
  <div class="online-users-sidebar">
    <div class="online-users-header">
      <h3>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
      <span class="online-count" id="online-count">0 –æ–Ω–ª–∞–π–Ω</span>
    </div>
    <div class="online-users-list" id="online-users-list">
      <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ WebSocket -->
      <div class="no-users">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–Ω–ª–∞–π–Ω</div>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ —á–∞—Ç–∞ -->
  <div class="chat-main">
    <div class="chat-container">
      <div class="chat-messages" id="chat-messages">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Django –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
      </div>
    </div>

    <div class="message-form-container">
      <form method="post" action="." class="message-form" id="message-form">
        {% csrf_token %}
        <input
          type="text"
          name="content"
          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
          id="chat-message-input"
        />
        <button type="button" id="chat-message-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π -->
<div id="private-message-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <p>–ö–æ–º—É: <span id="private-message-to"></span></p>
      <textarea 
        id="private-message-input" 
        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
        rows="4"
      ></textarea>
    </div>
    <div class="modal-footer">
      <button id="send-private-message" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="cancel-private-message" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>
{% endblock %} 

{% block scripts %} 
{{ room.slug|json_script:"json-roomname" }}
{{ request.user.username|json_script:"json-username" }}
<!-- –ü–µ—Ä–µ–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Django –≤ JavaScript -->
<script id="django-messages" type="application/json">
  {{ messages_json|safe }}
</script>
<script>
  // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
  let chatSocket = null;
  let roomName, userName;
  let messageHistory = new Set();
  let onlineUsers = new Set();
  let privateMessageModal = null;
  let currentPrivateRecipient = null;

  // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
  document.addEventListener("DOMContentLoaded", function () {
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setTimeout(initializeChat, 100);
  });

  function initializeChat() {
    try {
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Django
      const roomNameElement = document.getElementById("json-roomname");
      const userNameElement = document.getElementById("json-username");

      if (!roomNameElement || !userNameElement) {
        console.error("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM");
        showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.", "error");
        return;
      }

      roomName = JSON.parse(roomNameElement.textContent);
      userName = JSON.parse(userNameElement.textContent);

      if (!roomName || !userName) {
        console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å roomName –∏–ª–∏ userName");
        showNotification("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∫–æ–º–Ω–∞—Ç—ã", "error");
        return;
      }

      console.log("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã:", roomName);
      console.log("üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", userName);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      onlineUsers.add(userName);
      updateOnlineUsersDisplay();

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      initializePrivateMessages();
      
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      requestNotificationPermission();

      // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Django, –ø–æ—Ç–æ–º —Å–æ–∑–¥–∞–µ–º WebSocket
      loadInitialMessages();

      // –°–æ–∑–¥–∞–µ–º WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
      setTimeout(createWebSocket, 500);

      setupUIHandlers();
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞:", error);
      showNotification("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.", "error");
    }
  }

  function initializePrivateMessages() {
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    createPrivateMessageModal();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    setupPrivateMessageHandlers();
  }

  function createPrivateMessageModal() {
    privateMessageModal = document.getElementById('private-message-modal');
    
    if (!privateMessageModal) {
      console.error("‚ùå –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DOM");
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    privateMessageModal.querySelector('.close').addEventListener('click', closePrivateMessageModal);
    privateMessageModal.querySelector('#cancel-private-message').addEventListener('click', closePrivateMessageModal);
    privateMessageModal.querySelector('#send-private-message').addEventListener('click', sendPrivateMessage);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
    privateMessageModal.addEventListener('click', function(e) {
      if (e.target === privateMessageModal) {
        closePrivateMessageModal();
      }
    });
  }

  function setupPrivateMessageHandlers() {
    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    document.addEventListener('click', function(e) {
      const userItem = e.target.closest('.user-item');
      if (userItem && !userItem.classList.contains('current-user')) {
        const userName = userItem.querySelector('.user-name').textContent;
        openPrivateMessageModal(userName);
      }
    });
  }

  function openPrivateMessageModal(userName) {
    currentPrivateRecipient = userName;
    document.getElementById('private-message-to').textContent = userName;
    privateMessageModal.style.display = 'block';
    document.getElementById('private-message-input').focus();
  }

  function closePrivateMessageModal() {
    privateMessageModal.style.display = 'none';
    currentPrivateRecipient = null;
    document.getElementById('private-message-input').value = '';
  }

  function sendPrivateMessage() {
    const messageInput = document.getElementById('private-message-input');
    const message = messageInput.value.trim();

    if (!message) {
      showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
      return;
    }

    if (!currentPrivateRecipient) {
      showNotification('–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error');
      return;
    }

    if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
      showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'error');
      return;
    }

    try {
      const messageData = {
        type: 'private_message',
        message: message,
        to_username: currentPrivateRecipient,
        username: userName
      };

      console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', messageData);
      chatSocket.send(JSON.stringify(messageData));

      closePrivateMessageModal();
      showNotification('–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–∏—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
      showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
    }
  }

  // –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –ò–°–•–û–î–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô –ò–ó DJANGO
  function loadInitialMessages() {
    try {
      const djangoMessagesElement = document.getElementById("django-messages");
      const chatMessages = document.querySelector("#chat-messages");

      if (!chatMessages) {
        console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç chat-messages –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
      }

      // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
      chatMessages.innerHTML = "";

      if (djangoMessagesElement && djangoMessagesElement.textContent) {
        const djangoMessages = JSON.parse(djangoMessagesElement.textContent);
        console.log("üìö –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Django:", djangoMessages.length);

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Django
        djangoMessages.forEach((djangoMsg) => {
          const messageKey = `${djangoMsg.user?.username || "unknown"}_${
            djangoMsg.content
          }_${djangoMsg.timestamp || new Date().toISOString()}`;
          if (!messageHistory.has(messageKey)) {
            displayMessage(
              djangoMsg.user?.username || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",
              djangoMsg.content,
              djangoMsg.timestamp
            );
            messageHistory.add(messageKey);
          }
        });

        console.log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Django –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã");
      } else {
        console.log("‚ÑπÔ∏è –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Django –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è");
        chatMessages.innerHTML = '<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
      }
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Django:", error);
    }
  }

  function createWebSocket() {
    try {
      if (chatSocket) {
        chatSocket.close();
      }

      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl = protocol + "//" + window.location.host + "/ws/" + roomName + "/";
      console.log("üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫:", wsUrl);

      chatSocket = new WebSocket(wsUrl);
      setupWebSocketHandlers();
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket:", error);
      showNotification("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...", "warning");
      setTimeout(createWebSocket, 3000);
    }
  }

  function setupWebSocketHandlers() {
    if (!chatSocket) {
      console.error("‚ùå WebSocket –Ω–µ —Å–æ–∑–¥–∞–Ω");
      return;
    }

    chatSocket.onopen = function (e) {
      console.log("‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
      showNotification("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "success");
    };

    chatSocket.onerror = function (error) {
      console.log("‚ùå WebSocket –æ—à–∏–±–∫–∞:", error);
      showNotification("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —á–∞—Ç–æ–º", "error");
    };

    chatSocket.onmessage = function (e) {
      console.log("üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", e.data);
      try {
        const data = JSON.parse(e.data);

        if (data.type === "history") {
          handleHistoryMessage(data.messages);
        } else if (data.type === "new_message") {
          handleChatMessage(data);
        } else if (data.type === "user_activity") {
          handleUserActivity(data);
        } else if (data.type === "online_users") {
          handleOnlineUsers(data);
        } else if (data.type === "private_message") {
          handlePrivateMessage(data);
        } else if (data.type === "private_history") {
          handlePrivateHistory(data);
        } else if (data.type === "private_message_sent") {
          handlePrivateMessageSent(data);
        } else if (data.type === "error") {
          console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data.message);
          showNotification(data.message, "error");
        } else {
          console.log("‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:", data);
        }
      } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", error);
      }
    };

    chatSocket.onclose = function (e) {
      console.log("üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ, –∫–æ–¥:", e.code, "–ø—Ä–∏—á–∏–Ω–∞:", e.reason);
      showNotification("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...", "warning");
      setTimeout(createWebSocket, 3000);
    };
  }

  // –û–ë–†–ê–ë–û–¢–ö–ê –ò–°–¢–û–†–ò–ò –°–û–û–ë–©–ï–ù–ò–ô
  function handleHistoryMessage(messages) {
    console.log("üìö –ü–æ–ª—É—á–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:", messages.length);

    messages.forEach((messageData) => {
      const messageKey = `${messageData.username}_${messageData.message}_${messageData.date_added}`;
      if (!messageHistory.has(messageKey)) {
        displayMessage(
          messageData.username,
          messageData.message,
          messageData.date_added
        );
        messageHistory.add(messageKey);
      }
    });
  }

  // –û–ë–†–ê–ë–û–¢–ö–ê –ß–ê–¢-–°–û–û–ë–©–ï–ù–ò–ô
  function handleChatMessage(data) {
    console.log("üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:", data.username);

    // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
    const messageKey = `${data.username}_${data.message}_${data.timestamp}`;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏ –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (!messageHistory.has(messageKey)) {
      displayMessage(data.username, data.message, data.timestamp);
      messageHistory.add(messageKey);
    }
  }

  // –û–ë–†–ê–ë–û–¢–ö–ê –õ–ò–ß–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô
  function handlePrivateMessage(data) {
    console.log('üíå –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:', data.from_username);
    
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showPrivateMessageNotification(data.from_username, data.message);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ —Å –ø–æ–º–µ—Ç–∫–æ–π [–õ–°]
    displayPrivateMessage(data.from_username, data.message, data.timestamp);
  }

  function handlePrivateHistory(data) {
    console.log('üìö –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', data.messages.length);
    
    data.messages.forEach(msg => {
      if (msg.direction === 'received') {
        displayPrivateMessage(msg.from_username, msg.message, msg.timestamp);
      }
    });
  }

  function handlePrivateMessageSent(data) {
    console.log('‚úÖ –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', data.to_username);
    displayPrivateMessageSent(data.to_username, data.message, data.timestamp);
  }

  function showPrivateMessageNotification(fromUser, message) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    if ("Notification" in window && Notification.permission === "granted") {
      new Notification(`–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${fromUser}`, {
        body: message,
        icon: '/static/core/images/icon.png'
      });
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
    const notification = document.createElement('div');
    notification.className = 'notification notification-private';
    notification.innerHTML = `
      <div class="notification-content">
        <span class="notification-icon">üíå</span>
        <div>
          <strong>–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${fromUser}</strong>
          <p>${message}</p>
        </div>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 5000);
  }

  function displayPrivateMessage(fromUser, message, timestamp) {
    const chatMessages = document.querySelector("#chat-messages");
    if (!chatMessages) return;

    const displayTime = timestamp ? 
      new Date(timestamp).toLocaleTimeString() : 
      new Date().toLocaleTimeString();

    const messageHTML = `
      <div class="message private-message">
        <p class="message-username">üíå ${fromUser} [–õ–°]</p>
        <p class="message-content">${message}</p>
        <p class="message-time">${displayTime}</p>
      </div>
    `;

    chatMessages.innerHTML += messageHTML;
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function displayPrivateMessageSent(toUser, message, timestamp) {
    const chatMessages = document.querySelector("#chat-messages");
    if (!chatMessages) return;

    const displayTime = timestamp ? 
      new Date(timestamp).toLocaleTimeString() : 
      new Date().toLocaleTimeString();

    const messageHTML = `
      <div class="message private-message-sent">
        <p class="message-username">üíå –í—ã -> ${toUser} [–õ–°]</p>
        <p class="message-content">${message}</p>
        <p class="message-time">${displayTime}</p>
      </div>
    `;

    chatMessages.innerHTML += messageHTML;
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  function handleUserActivity(data) {
    if (data.activity === "joined") {
      handleUserJoin(data.username);
    } else if (data.activity === "left") {
      handleUserLeave(data.username);
    }

    showChatNotification(data.message, data.activity);
  }

  function handleOnlineUsers(data) {
    console.log("üë• –ü–æ–ª—É—á–µ–Ω —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", data.users);
    onlineUsers = new Set(data.users);
    updateOnlineUsersDisplay();
  }

  function handleUserJoin(username) {
    console.log("üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è:", username);
    onlineUsers.add(username);
    updateOnlineUsersDisplay();
  }

  function handleUserLeave(username) {
    console.log("üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç:", username);
    onlineUsers.delete(username);
    updateOnlineUsersDisplay();
  }

  function updateOnlineUsersDisplay() {
    const usersList = document.getElementById("online-users-list");
    const onlineCount = document.getElementById("online-count");

    if (!usersList) return;

    if (onlineCount) {
      onlineCount.textContent = `${onlineUsers.size} –æ–Ω–ª–∞–π–Ω`;
    }

    usersList.innerHTML = "";

    if (onlineUsers.size === 0) {
      usersList.innerHTML = '<div class="no-users">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–Ω–ª–∞–π–Ω</div>';
      return;
    }

    const sortedUsers = Array.from(onlineUsers).sort((a, b) => {
      if (a === userName) return -1;
      if (b === userName) return 1;
      return a.localeCompare(b);
    });

    sortedUsers.forEach((user) => {
      const userItem = document.createElement("div");
      userItem.className = `user-item ${user === userName ? "current-user" : ""}`;
      const avatarText = user.substring(0, 2).toUpperCase();

      userItem.innerHTML = `
        <div class="user-avatar">${avatarText}</div>
        <div class="user-info">
          <div class="user-name">${user}</div>
          <div class="user-status">online</div>
        </div>
      `;

      usersList.appendChild(userItem);
    });
  }

  function showChatNotification(message, type) {
    const chatMessages = document.querySelector("#chat-messages");
    if (!chatMessages) return;

    const notificationClass = type === "joined" ? "user-join-notification" : "user-leave-notification";
    const notificationHTML = `<div class="${notificationClass}">${message}</div>`;

    chatMessages.innerHTML += notificationHTML;
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function displayMessage(username, message, timestamp = null) {
    const chatMessages = document.querySelector("#chat-messages");
    if (!chatMessages) return;

    const isCurrentUser = username === userName;
    const messageClass = isCurrentUser ? "message-current-user" : "message-other-user";
    const displayTime = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();

    const messageHTML = `
      <div class="message ${messageClass}">
        <p class="message-username">${username}</p>
        <p class="message-content">${message}</p>
        <p class="message-time">${displayTime}</p>
      </div>
    `;

    chatMessages.innerHTML += messageHTML;
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function setupUIHandlers() {
    const submitButton = document.querySelector("#chat-message-submit");
    const messageInput = document.querySelector("#chat-message-input");
    const messageForm = document.querySelector("#message-form");

    if (!submitButton || !messageInput) {
      console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
      return;
    }

    submitButton.addEventListener("click", function (e) {
      e.preventDefault();
      sendMessage();
    });

    if (messageForm) {
      messageForm.addEventListener("submit", function (e) {
        e.preventDefault();
        sendMessage();
      });
    }

    messageInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });
  }

  function sendMessage() {
    if (!chatSocket) {
      console.error("‚ùå WebSocket –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
      showNotification("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.", "error");
      return;
    }

    if (chatSocket.readyState !== WebSocket.OPEN) {
      console.error("‚ùå WebSocket –Ω–µ –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ. –°–æ—Å—Ç–æ—è–Ω–∏–µ:", chatSocket.readyState);
      showNotification("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...", "warning");
      setTimeout(createWebSocket, 1000);
      return;
    }

    const messageInput = document.querySelector("#chat-message-input");
    const message = messageInput.value.trim();

    if (!message) {
      console.warn("‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");
      return;
    }

    if (!userName) {
      console.error("‚ùå –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ");
      showNotification("–û—à–∏–±–∫–∞: –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ", "error");
      return;
    }

    try {
      const messageData = {
        message: message,
        username: userName,
        room: roomName,
      };

      console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:", messageData);
      chatSocket.send(JSON.stringify(messageData));

      messageInput.value = "";
      console.log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ");
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
      showNotification("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è", "error");
    }
  }

  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission();
    }
  }

  function showNotification(message, type = "info") {
    const notification = document.createElement("div");
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
      <div class="notification-content">
        <span class="notification-icon">${
          type === "success" ? "‚úÖ" :
          type === "error" ? "‚ùå" :
          type === "warning" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è"
        }</span>
        <span>${message}</span>
      </div>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 5000);
  }

  // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
  window.addEventListener("load", function () {
    const messageInput = document.querySelector("#chat-message-input");
    if (messageInput) {
      messageInput.focus();
    }
  });

  window.addEventListener("beforeunload", function () {
    if (chatSocket) {
      chatSocket.close(1000, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É");
    }
  });
</script>
{% endblock %}